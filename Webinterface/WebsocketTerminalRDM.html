<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
<title>Websocket Terminal for RDM53</title>
<link rel="stylesheet" type="text/css" href="ProperToolStyle.css" />
<!--
	This file is the RDM Webinterface
	Date: 2019 07 04
	Author: Pascal Pfeiffer
-->
<style>
	.collapsible {
	  background-color: #777;
	  color: white;
	  cursor: pointer;
	  padding: 18px;
	  width: 100%;
	  border: none;
	  text-align: left;
	  outline: none;
	  font-size: 15px;
	}
	
	.active, .collapsible:hover {
	  background-color: #555;
	}
	
	.content {
	  padding: 0 18px;
	  display: none;
	  overflow: hidden;
	  background-color: #f1f1f1;
	}
	</style>
</head>
<body>



<div id="PageContent">
	
	<h1><a href='/Tools/WebsocketTerminal.html' target="_self" >Websocket Terminal for RDM53</a> </h1><br>
	<div>
	last update: 23 09 19 <br> <br> <br>
	Change IP Address: 	<input id="IPInputString" type="url" style="width:30em" placeholder="ws://xxx.xxx.xxx.xxx:xx"/>
	<button type="button" id="buttonChangeIP" onclick="refreshIPAdress(id);" value="IPInputString">Change IP</button></br>
	Server IP Adress: 	<span id="WebSocketIPScreen"></span>
						<button type="button" id="IPSocket" onclick="EndWebsocketClient();" value="IPInput1">Disconnect</button><br>
	Status: 			<span id="WebSocketConnectionStateScreen"> disconnected </span>
	<button type="button" id="buttonRefreshConnection" onclick="retryConnection()">Retry Connection</button>
	<br>
	</div>
	<button class="collapsible"><h2>Raw Data</h2></button>
	<div class="content">
	String Command: 			<input id="TerminalInputStr" type="text" style="width:40em" placeholder="Enter String commands!" />
						<button type="button" id="websocketStrCmdSend" onclick="sendCommandOnClick(value);" value="TerminalInputStr">Send</button></br>
	Hex Command:		<input id="TerminalInputHex" type="text" style="width:40em" placeholder="Enter Hex commands!" />
						<button type="button" id="websocketHexCmdSend" onclick="WebHexCmdSend(value);" value="TerminalInputHex">Send</button></br>
	Sent strings: </br>
	<textarea name="text" id="commandStore" style="width:40%" rows="10" readonly placeholder="Sent data appears here..." ></textarea>
	<textarea name="text" id="receiveStore" style="width:40%" rows="10" readonly placeholder="Received data appears here..." ></textarea><br>
	<textarea name="text" style="width:40%" id="StoreHexSent" rows="10" readonly placeholder="Sent Hex values appear here" ></textarea>
	<textarea name="text" style="width:40%" id="StoreHexReceived" rows="10" readonly placeholder="Received Hex values appear here" ></textarea></br>
    <textarea name="text" style="width:81%" id="AllStore" rows="10" readonly placeholder="All data appears here..."></textarea>
	</div>

	<button class="collapsible"><h2>Calibration</h2></button>
	<div class="content">
		<button type="button" id="buttonCalibrateMagnetometer" onclick="WebHexCmdSend(id);" value="11030100000000000012">Calibrate Magnetometer</button></br>
		<table>
		<tr>
			<th> <button type="button" id="buttonGetXOffet" onclick="WebHexCmdSend(id);" value="1103031F000000000012">Get x Offset</button></th>
			<th> <div id="buttonGetXOffsetDisplay">none</div></th>
			<th> <button type="button" id="buttonGetXScale" onclick="WebHexCmdSend(id);"value="1103031F000000000012">Get x Scale</button></th>
			<th> <div id="buttonGetXScaleDisplay">none</div></th>
		</tr><tr>
			<th><button type="button" id="buttonGetYOffet" onclick="WebHexCmdSend(id);" value="11030320000000000012">Get y Offset</button></th>
			<th><div id="buttonGetYOffsetDisplay">none</div></th>
			<th> <button type="button" id="buttonGetYScale" onclick="WebHexCmdSend(id);"value="1103031F000000000012">Get y Scale</button></th>
			<th> <div id="buttonGetYScaleDisplay">none</div></th>
		</tr><tr>
			<th><button type="button" id="buttonGetZOffet" onclick="WebHexCmdSend(id);" value="11030321000000000012">Get z Offset</button></th>
			<th><div id="buttonGetZOffsetDisplay">none</div></th>
			<th> <button type="button" id="buttonGetZScale" onclick="WebHexCmdSend(id);"value="1103031F000000000012">Get z Scale</button></th>
			<th> <div id="buttonGetZScaleDisplay">none</div></th>
		</tr><tr>
			<th><button type="button" id="buttonGetAVGScale" onclick="WebHexCmdSend(id);" value="11030322000000000012">Get avg scale</button></br></th>
			<th><div id="buttonGetGetAVGScaleDisplay">none</div></th>
		</tr>
		</table>
	</br>
		<input id="CalibrationInput" type="text" style="width:40em" placeholder="Float"/>
		<button type="button" id="buttonSendXOffset" onclick="WebFloatToHexCmdSend(id);" value="11030100000000000012">Send x Offset</button>
		<button type="button" id="buttonSendYOffset" onclick="WebFloatToHexCmdSend(id);" value="11030100000000000012">Send y Offset</button>
		<button type="button" id="buttonSendZOffset" onclick="WebFloatToHexCmdSend(id);" value="11030100000000000012">Send z Offset</button>
		<button type="button" id="buttonSendAVGScale" onclick="WebFloatToHexCmdSend(id);" value="11030100000000000012">Send avg scale</button>
	</br>
		<button type="button" id="buttonSendXScale" onclick="WebFloatToHexCmdSend(id);" value="11030100000000000012">Send x Scale</button>
		<button type="button" id="buttonSendYScale" onclick="WebFloatToHexCmdSend(id);" value="11030100000000000012">Send y Scale</button>
		<button type="button" id="buttonSendZScale" onclick="WebFloatToHexCmdSend(id);" value="11030100000000000012">Send z Scale</button>
	</br>
		<button type="button" id="buttonSendKp" onclick="WebFloatToHexCmdSend(id);" value="11030100000000000012">Send Proportional Value</button>
		<button type="button" id="buttonSendKi" onclick="WebFloatToHexCmdSend(id);" value="11030100000000000012">Send Integral Value</button>
	</div>
	<button class="collapsible"><h2>Device Values</h2></button>
	<div class="content">
		<table>
			  <tr>
				<th><button type="button" id="buttonBatteryStatus" onclick="WebHexCmdSend(id);" value="11030310000000000012">Battery status</button></th>
				<th><div id="BatteryStatusDisplay"></div></th>
				
				<td><button type="button" id="buttonLidar0Values" onclick="WebHexCmdSend(id);" value="11030300000000000012">Lidar 0</button></td>
				<td><div id="buttonLidar0ValuesDisplay">none</div></td>
				
				<td><button type="button" id="buttonLidar1Values" onclick="WebHexCmdSend(id);" value="11030301000000000012">Lidar 1</button></td>
				<td><div id="buttonLidar1ValuesDisplay">none</div></td>
				
				<td><button type="button" id="buttonLidar2Values" onclick="WebHexCmdSend(id);" value="11030302000000000012">Lidar 2</button></td>
				<td><div id="buttonLidar2ValuesDisplay">none</div></td>
				
				<td><button type="button" id="buttonLidar3Values" onclick="WebHexCmdSend(id);" value="11030303000000000012">Lidar 3</button></td>
				<td><div id="buttonLidar3ValuesDisplay">none</div></td>
			  </tr>
			  <tr>
				<td><button type="button" id="buttonUltrasonicValues" onclick="WebHexCmdSend(id);" value="11030308000000000012">Ultrasonic values</button></td>
				<td><div id="UltrasonicValuesDisplay">none</div></td>

				<td><button type="button" id="buttonLidar6Values" onclick="WebHexCmdSend(id);" value="11030306000000000012">Lidar 6</button></td>
				<td><div id="buttonLidar6ValuesDisplay">none</div></td>
				
				<td> </td>
				<td> </td>
				<td> </td>
				<td> </td>
				<td><button type="button" id="buttonLidar4Values" onclick="WebHexCmdSend(id);" value="11030304000000000012">Lidar 4</button></td>
				<td><div id="buttonLidar4ValuesDisplay">none</div></td>
				
			  </tr>
			  <tr>
				<td> </td>
				<td> </td>
				<td><button type="button" id="buttonLidar5Values" onclick="WebHexCmdSend(id);" value="11030305000000000012">Lidar 5</button></td>
				<td><div id="buttonLidar5ValuesDisplay">none</div></td>
				<td> </td>
				<td> </td>
				<td> </td>
				<td> </td>
			<tr>				
				<td><button type="button" id="buttonSpeedValues" onclick="WebHexCmdSend(id);" value="1103031B000000000012">Speed</button></td>
				<td><div id="buttonSpeedValuesDisplay">none</div></td>
				<td> </td>
				<td> </td>

				<td> </td>
				<td> </td>
				<td><button type="button" id="buttonCSValues" onclick="WebHexCmdSend(id);" value="1103031A000000000012">Color Sensor</button> </td>
				<td><div id="CSDisplay" style="border-style: solid; width: 1em; height: 1em"></div> </td>
		</table> 
		<table>
			<tr>
				<th><button type="button" id="buttonLTFLValues" onclick="WebHexCmdSend(id);" value="11030311000000000012">LT FL</button></th>
				<th><div id="LTFLDisplay" style="border-style: solid; width: 1em; height: 1em"></div></th>
				<th><button type="button" id="buttonLTFRValues" onclick="WebHexCmdSend(id);" value="11030312000000000012">LT FR</button></th>
				<th><div id="LTFRDisplay" style="border-style: solid; width: 1em; height: 1em"></div></th>
				<th><button type="button" id="buttonLTFLRawValues" onclick="WebHexCmdSend(id);" value="1103030C000000000012">LT FL Raw</button></th>
				<th><div id="LTFLRawDisplay"></div></th>
				<th><button type="button" id="buttonLTFRRawValues" onclick="WebHexCmdSend(id);" value="1103030D000000000012">LT FR Raw</button></th>
				<th><div id="LTFRRawDisplay"></div></th>
			</tr>
			<tr>
				<th><button type="button" id="buttonLTBLValues" onclick="WebHexCmdSend(id);" value="11030313000000000012">LT BL</button></th>
				<th><div id="LTBLDisplay" style="border-style: solid; width: 1em; height: 1em"></div></th>
				<th><button type="button" id="buttonLTBRValues" onclick="WebHexCmdSend(id);" value="11030314000000000012">LT BR</button></th>
				<th><div id="LTBRDisplay" style="border-style: solid; width: 1em; height: 1em"></div></th>
				<th><button type="button" id="buttonLTBLRawValues" onclick="WebHexCmdSend(id);" value="1103030E000000000012">LT BL Raw</button></th>
				<th><div id="LTBLRawDisplay"></div></th>
				<th><button type="button" id="buttonLTBRRawValues" onclick="WebHexCmdSend(id);" value="1103030F000000000012">LT BR Raw</button></th>
				<th><div id="LTBRRawDisplay"></div></th>
			</tr>
		</table>
		<button type="button" id="buttonGetHeadingValues" onclick="WebHexCmdSend(id);" value="11030316000000000012">Heading in Deg</button><br>
		<div id="GetHeadingDisplay"></div><br>
	</div>
	<button class="collapsible"><h2>Gamepad</h2></button>
	<div class="content">
		<button type="button" onclick="OnJoystickConnect();" value="Joystick">Connect Joystick</button>
		<button type="button" onclick="OnJoystickDisconnect();" value="JoystickDisconnect">Disconnect Joystick</button>
	</div>
	<button class="collapsible"><h2>Quick Commands</h2></button>
	<div class="content">
		<h2> Modes </h2>
		<button type="button" id="buttonChill" onclick="WebHexCmdSend(id);" value="11020200000000000012">Chill</button></br>
		<button type="button" id="buttonRCS0" onclick="WebHexCmdSend(id);" value="11020100000000000012">Remote Control Static</button></br>
		<button type="button" id="buttonRCD0" onclick="WebHexCmdSend(id);" value="11020100000000001012">Remote Control Dynamic</button></br>
		<button type="button" id="buttonRebootRDM0" onclick="WebHexCmdSend(id);" value="11020300000000000012">Reboot RDM53</button></br>
		<button type="button" id="buttonWiFiNotificationSender" onclick="WebHexCmdSend(id);" value="11030315000000000012">wiFiNotificationSender</button></br>
		<h2> Autonomy </h2>
		<button type="button" id="buttonAutonomous0" onclick="WebHexCmdSend(id);" value="11020000000000000012">Autonomous 0 - only line Track</button></br>
		<button type="button" id="buttonAutonomous1" onclick="WebHexCmdSend(id);" value="11020000000000000112">Autonomous 1 - only lidar</button></br>
		<button type="button" id="buttonAutonomous2" onclick="WebHexCmdSend(id);" value="11020000000000000212">Autonomous 2 - lidar and line Track</button></br>
		<button type="button" id="buttonAutonomous3" onclick="WebHexCmdSend(id);" value="11020000000000000312">Autonomous 3 - RNG Lab</button></br>
		<button type="button" id="buttonAutonomous4" onclick="WebHexCmdSend(id);" value="11020000000000000412">Autonomous 4</button></br>
	</div>	
</div>

</body>
<script>
    //var WebSocketIPAdress = 'ws://192.168.178.252:81';
    //var WebSocketIPAdress = 'wss://echo.websocket.org';
	//var WebSocketIPAdress = 'ws://192.168.178.42:81';
	//var WebSocketIPAdress = 'ws://172.20.10.4:81';
	//var WebSocketIPAdress = 'ws://192.168.43.156:81';
	//var WebSocketIPAdress = 'ws://172.20.10.9:81';
	//var WebSocketIPAdress = 'ws://192.168.43.185:81';
	//var WebSocketIPAdress = 'ws://10.3.141.206:81';
	var WebSocketIPAdress = 'ws://192.168.188.21:81';
	var WebConnection;

function WebFloatToHexCmdSend(id) {
	var tosendFloat;
	
	var farr = new Float32Array(1);  // indexes each element 4 bytes
	if(id == "buttonSendXOffset") {
		tosendFloat = parseFloat(document.getElementById("CalibrationInput").value);
	}
	else if(id == "buttonSendYOffset") {
		tosendFloat = parseFloat(document.getElementById("CalibrationInput").value);
	}
	else if(id == "buttonSendZOffset") {
		tosendFloat = parseFloat(document.getElementById("CalibrationInput").value);
	}
	else if(id == "buttonSendAVGScale") {
		tosendFloat = parseFloat(document.getElementById("CalibrationInput").value);
	}
	else if(id == "buttonSendXScale") {
		tosendFloat = parseFloat(document.getElementById("CalibrationInput").value);
	}
	else if(id == "buttonSendYScale") {
		tosendFloat = parseFloat(document.getElementById("CalibrationInput").value);
	}
	else if(id == "buttonSendZScale") {
		tosendFloat = parseFloat(document.getElementById("CalibrationInput").value);
	}
	else if(id == "buttonSendKp") {
		tosendFloat = parseFloat(document.getElementById("CalibrationInput").value);
	}
	else if(id == "buttonSendKi") {
		tosendFloat = parseFloat(document.getElementById("CalibrationInput").value);
	}
	else {
		console.log("id not found");
		return;
	}
	
	farr[0] = tosendFloat;
	
	var barr = new Uint8Array(farr.buffer);   // use the buffer of Float32Array view
	var arraybuffer = new Uint8Array(10);
	arraybuffer[0] = 0x11;
	arraybuffer[1] = 0x00;
	arraybuffer[2] = 0x00;
	arraybuffer[3] = 0x00;
	arraybuffer[4] = 0x00;
	
	arraybuffer[5] = barr[0];
	arraybuffer[6] = barr[1];
	arraybuffer[7] = barr[2];
	arraybuffer[8] = barr[3];
	arraybuffer[9] = 0x12;
	
	// 11 03 01 01 00 00 00 00 00 12
	// -- -- -- -- -- ## ## ## ## --
	if(id == "buttonSendXOffset") {
		arraybuffer[1] = 0x03;
		arraybuffer[2] = 0x01;
		arraybuffer[3] = 0x01;
		arraybuffer[4] = 0x00;
	}
	// 11 03 01 02 00 00 00 00 00 12
	// -- -- -- -- -- ## ## ## ## --
	else if(id == "buttonSendYOffset") {
		arraybuffer[1] = 0x03;
		arraybuffer[2] = 0x01;
		arraybuffer[3] = 0x02;
		arraybuffer[4] = 0x00;
	}
	// 11 03 01 03 00 00 00 00 00 12
	// -- -- -- -- -- ## ## ## ## --
	else if(id == "buttonSendZOffset") {
		arraybuffer[1] = 0x03;
		arraybuffer[2] = 0x01;
		arraybuffer[3] = 0x03;
		arraybuffer[4] = 0x00;
	}
	// 11 03 01 04 00 00 00 00 00 12
	// -- -- -- -- -- ## ## ## ## --
	else if(id == "buttonSendAVGScale") {
		arraybuffer[1] = 0x03;
		arraybuffer[2] = 0x01;
		arraybuffer[3] = 0x04;
		arraybuffer[4] = 0x00;
	}
	// 11 03 01 04 00 00 00 00 00 12
	// -- -- -- -- -- ## ## ## ## --
	else if(id == "buttonSendXScale") {
		arraybuffer[1] = 0x03;
		arraybuffer[2] = 0x01;
		arraybuffer[3] = 0x05;
		arraybuffer[4] = 0x00;
	}
	// 11 03 01 04 00 00 00 00 00 12
	// -- -- -- -- -- ## ## ## ## --
	else if(id == "buttonSendYScale") {
		arraybuffer[1] = 0x03;
		arraybuffer[2] = 0x01;
		arraybuffer[3] = 0x06;
		arraybuffer[4] = 0x00;
	}
	// 11 03 01 04 00 00 00 00 00 12
	// -- -- -- -- -- ## ## ## ## --
	else if(id == "buttonSendZScale") {
		arraybuffer[1] = 0x03;
		arraybuffer[2] = 0x01;
		arraybuffer[3] = 0x07;
		arraybuffer[4] = 0x00;
	}
	// 11 03 01 04 00 00 00 00 00 12
	// -- -- -- -- -- ## ## ## ## --
	else if(id == "buttonSendKp") {
		arraybuffer[1] = 0x03;
		arraybuffer[2] = 0x01;
		arraybuffer[3] = 0x08;
		arraybuffer[4] = 0x00;
	}
	// 11 03 01 04 00 00 00 00 00 12
	// -- -- -- -- -- ## ## ## ## --
	else if(id == "buttonSendKi") {
		arraybuffer[1] = 0x03;
		arraybuffer[2] = 0x01;
		arraybuffer[3] = 0x09;
		arraybuffer[4] = 0x00;
	}
	
	WebConnection.send(arraybuffer.buffer);
	
	// console.log(barr);
	// console.log(arraybuffer);
	// console.log(tosendFloat);
}

document.getElementById("WebSocketIPScreen").innerHTML = WebSocketIPAdress;
    WebConnection = new WebSocket(WebSocketIPAdress, ['arduino']);
    WebConnection.binaryType = "arraybuffer"; //Binaertyp auf arraybuffer setzen

WebConnection.onopen = function () {
	console.log("Succesful connected!");
    screenStatus(true);
};

WebConnection.onerror = function (error) {
	console.log('WebSocket Error: ', error);
	screenStatus(2);
};

WebConnection.onmessage = function (e) {
	// receive String
	if(typeof e.data === 'string' ) {
		console.log('Server: ', e.data);
		storeReceivedData(e.data);
   }
	// receive Array
	if(e.data instanceof ArrayBuffer ){
	  var hexBuf = buf2hex(e.data);
      console.log("Received arraybuffer: " + hexBuf);
	  if(checkIfValIsKnown(hexBuf)) {
		StoreReceivedHexData(hexBuf);
	}
   }
   // console.log("Something received");
};

WebConnection.onclose = function (e) {
	screenStatus(false);
}

function refreshIPAdress(_address)
{
	WebSocketIPAdress = _address;
	retryConnection();
}

function retryConnection() {
	WebConnection = new WebSocket(WebSocketIPAdress, ['arduino']);
    WebConnection.binaryType = "arraybuffer"; //Binaertyp auf arraybuffer setzen
}

function checkIfValIsKnown(value) {
	var retVal = 1;
	var dev = value.substring(2, 10);
	switch(dev) {
		case "01001000":
			payload = value.substring(10, 18);
			document.getElementById("BatteryStatusDisplay").innerHTML = parseInt(payload, 16).toString() + "%";
		break;
		case "01000800":
			payload = value.substring(10, 18);
			document.getElementById("UltrasonicValuesDisplay").innerHTML = parseInt(payload, 16).toString() + "mm";
		break;
		case "01000000":
			payload = value.substring(10, 18);
			document.getElementById("buttonLidar0ValuesDisplay").innerHTML = parseInt(payload, 16).toString() + "mm";
		break;
		case "01000100":
			payload = value.substring(10, 18);
			document.getElementById("buttonLidar1ValuesDisplay").innerHTML = parseInt(payload, 16).toString() + "mm";
		break;
		case "01000200":
			payload = value.substring(10, 18);
			document.getElementById("buttonLidar2ValuesDisplay").innerHTML = parseInt(payload, 16).toString() + "mm";
		break;
		case "01000300":
			payload = value.substring(10, 18);
			document.getElementById("buttonLidar3ValuesDisplay").innerHTML = parseInt(payload, 16).toString() + "mm";
		break;
		case "01000400":
			payload = value.substring(10, 18);
			document.getElementById("buttonLidar4ValuesDisplay").innerHTML = parseInt(payload, 16).toString() + "mm";
		break;
		case "01000500":
			payload = value.substring(10, 18);
			document.getElementById("buttonLidar5ValuesDisplay").innerHTML = parseInt(payload, 16).toString() + "mm";
		break;
		case "01000600":
			payload = value.substring(10, 18);
			document.getElementById("buttonLidar6ValuesDisplay").innerHTML = parseInt(payload, 16).toString() + "mm";
		break;
		case "01000c00":
			payload = value.substring(10, 18);
			document.getElementById("LTFLRawDisplay").innerHTML = parseInt(payload, 16).toString();
		break;
		case "01000d00":
			payload = value.substring(10, 18);
			document.getElementById("LTFRRawDisplay").innerHTML = parseInt(payload, 16).toString();
		break;
		case "01000e00":
			payload = value.substring(10, 18);
			document.getElementById("LTBLRawDisplay").innerHTML = parseInt(payload, 16).toString();
		break;
		case "01000f00":
			payload = value.substring(10, 18);
			document.getElementById("LTBRRawDisplay").innerHTML = parseInt(payload, 16).toString();
		break;
		case "01001100":
			payload = value.substring(10, 18);
			if(parseInt(payload, 16).toString() == "1") { // floor
				document.getElementById("LTFLDisplay").style.backgroundColor= "white";
			}
			else if(parseInt(payload, 16).toString() == "0") { // line
				document.getElementById("LTFLDisplay").style.backgroundColor= "black";
			}
			else if(parseInt(payload, 16).toString() == "2") { // enemy goal
				document.getElementById("LTFLDisplay").style.backgroundColor= "yellow";
			}
			else if(parseInt(payload, 16).toString() == "3") { // our goal
				document.getElementById("LTFLDisplay").style.backgroundColor= "green";
			}
			else { // error
				document.getElementById("LTFLDisplay").style.backgroundColor= "red";
			}
		break;
		case "01001200":
			payload = value.substring(10, 18);
			if(parseInt(payload, 16).toString() == "1") { // floor
				document.getElementById("LTFRDisplay").style.backgroundColor= "white";
			}
			else if(parseInt(payload, 16).toString() == "0") { // line
				document.getElementById("LTFRDisplay").style.backgroundColor= "black";
			}
			else if(parseInt(payload, 16).toString() == "2") { // enemy goal
				document.getElementById("LTFRDisplay").style.backgroundColor= "yellow";
			}
			else if(parseInt(payload, 16).toString() == "3") { // our goal
				document.getElementById("LTFRDisplay").style.backgroundColor= "green";
			}
			else { // error
				document.getElementById("LTFRDisplay").style.backgroundColor= "red";
			}
		break;
		case "01001300":
			payload = value.substring(10, 18);
			if(parseInt(payload, 16).toString() == "1") { // floor
				document.getElementById("LTBLDisplay").style.backgroundColor= "white";
			}
			else if(parseInt(payload, 16).toString() == "0") { // line
				document.getElementById("LTBLDisplay").style.backgroundColor= "black";
			}
			else if(parseInt(payload, 16).toString() == "2") { // enemy goal
				document.getElementById("LTBLDisplay").style.backgroundColor= "yellow";
			}
			else if(parseInt(payload, 16).toString() == "3") { // our goal
				document.getElementById("LTBLDisplay").style.backgroundColor= "green";
			}
			else { // error
				document.getElementById("LTBLDisplay").style.backgroundColor= "red";
			}
		break;
		case "01001400":
			payload = value.substring(10, 18);
			if(parseInt(payload, 16).toString() == "1") { // floor
				document.getElementById("LTBRDisplay").style.backgroundColor= "white";
			}
			else if(parseInt(payload, 16).toString() == "0") { // line
				document.getElementById("LTBRDisplay").style.backgroundColor= "black";
			}
			else if(parseInt(payload, 16).toString() == "2") { // enemy goal
				document.getElementById("LTBRDisplay").style.backgroundColor= "yellow";
			}
			else if(parseInt(payload, 16).toString() == "3") { // our goal
				document.getElementById("LTBRDisplay").style.backgroundColor= "green";
			}
			else { // error
				document.getElementById("LTBRDisplay").style.backgroundColor= "red";
			}
		break;
		case "01001a00":
			// Color Sensor
			payload = value.substring(10, 18);
			if(parseInt(payload, 16).toString() == "1") { // floor
				document.getElementById("CSDisplay").style.backgroundColor= "white";
			}
			else if(parseInt(payload, 16).toString() == "0") { // line
				document.getElementById("CSDisplay").style.backgroundColor= "black";
			}
			else if(parseInt(payload, 16).toString() == "2") { // enemy goal
				document.getElementById("CSDisplay").style.backgroundColor= "yellow";
			}
			else if(parseInt(payload, 16).toString() == "3") { // our goal
				document.getElementById("CSDisplay").style.backgroundColor= "green";
			}
			else { // error
				document.getElementById("CSDisplay").style.backgroundColor= "red";
			}
		break;
		/*
		case "01001700":
			payload = value.substring(10, 18);
			var buf = new ArrayBuffer(4);
			var view = new DataView(buf);
			data.forEach(function(b,i) {
				view.setUint8(i, b);
			});
			var num = view.getFloat32(0);
			document.getElementById("Pitch").innerHTML = parseFloat(payload, 16).toString();
		break;
		
		case "01001800":
			payload = value.substring(10, 18);
			var buf = new ArrayBuffer(4);
			var view = new DataView(buf);
			data.forEach(function(b,i) {
				view.setUint8(i, b);
			});
			var num = view.getFloat32(0);
			document.getElementById("Roll").innerHTML = parseFloat(payload, 16).toString();
		break;
		*/
		case "01001b00":
			// speed
			payload = value.substring(10, 18);
			
			var p0 = payload.substring(0, 2);
			var p1 = payload.substring(2, 4);
			var p2 = payload.substring(4, 6);
			var p3 = payload.substring(6, 8);
			
			var data = [ parseInt(p3, 16), parseInt(p2, 16), parseInt(p1, 16), parseInt(p0, 16)];
			
			var buf = new ArrayBuffer(4);
			var view = new DataView(buf);
			data.forEach(function(b,i) {
				view.setUint8(i, b);
			});
			var num = view.getFloat32(0);
			document.getElementById("buttonSpeedValuesDisplay").innerHTML = (num.toString().substring(0,5) + "m/s");
		break;
		case "01001600":
			// heading
			payload = value.substring(10, 18);
			
			var p0 = payload.substring(0, 2);
			var p1 = payload.substring(2, 4);
			var p2 = payload.substring(4, 6);
			var p3 = payload.substring(6, 8);
			
			var data = [ parseInt(p3, 16), parseInt(p2, 16), parseInt(p1, 16), parseInt(p0, 16)];
			
			var buf = new ArrayBuffer(4);
			var view = new DataView(buf);
			data.forEach(function(b,i) {
				view.setUint8(i, b);
			});
			var num = view.getFloat32(0);
			document.getElementById("GetHeadingDisplay").innerHTML = (num.toString().substring(0,5) + "°");
			break;
		// get x offset
		case "01001f00":
			payload = value.substring(10, 18);
			
			var p0 = payload.substring(0, 2);
			var p1 = payload.substring(2, 4);
			var p2 = payload.substring(4, 6);
			var p3 = payload.substring(6, 8);
			
			var data = [ parseInt(p3, 16), parseInt(p2, 16), parseInt(p1, 16), parseInt(p0, 16)];
			
			var buf = new ArrayBuffer(4);
			var view = new DataView(buf);
			data.forEach(function(b,i) {
				view.setUint8(i, b);
			});
			var num = view.getFloat32(0);
		document.getElementById("buttonGetXOffsetDisplay").innerHTML = (num.toString().substring(0,5));
		break;
		// get y offset
		case "01002000":
			payload = value.substring(10, 18);
			
			var p0 = payload.substring(0, 2);
			var p1 = payload.substring(2, 4);
			var p2 = payload.substring(4, 6);
			var p3 = payload.substring(6, 8);
			
			var data = [ parseInt(p3, 16), parseInt(p2, 16), parseInt(p1, 16), parseInt(p0, 16)];
			
			var buf = new ArrayBuffer(4);
			var view = new DataView(buf);
			data.forEach(function(b,i) {
				view.setUint8(i, b);
			});
			var num = view.getFloat32(0);
		document.getElementById("buttonGetYOffsetDisplay").innerHTML = (num.toString().substring(0,5));
		break;
		// get z offset
		case "01002100":
			payload = value.substring(10, 18);
			
			var p0 = payload.substring(0, 2);
			var p1 = payload.substring(2, 4);
			var p2 = payload.substring(4, 6);
			var p3 = payload.substring(6, 8);
			
			var data = [ parseInt(p3, 16), parseInt(p2, 16), parseInt(p1, 16), parseInt(p0, 16)];
			
			var buf = new ArrayBuffer(4);
			var view = new DataView(buf);
			data.forEach(function(b,i) {
				view.setUint8(i, b);
			});
			var num = view.getFloat32(0);
		document.getElementById("buttonGetZOffsetDisplay").innerHTML = (num.toString().substring(0,5));
		break;
		// get avg scale display
		case "01002200":
			payload = value.substring(10, 18);
			
			var p0 = payload.substring(0, 2);
			var p1 = payload.substring(2, 4);
			var p2 = payload.substring(4, 6);
			var p3 = payload.substring(6, 8);
			
			var data = [ parseInt(p3, 16), parseInt(p2, 16), parseInt(p1, 16), parseInt(p0, 16)];
			
			var buf = new ArrayBuffer(4);
			var view = new DataView(buf);
			data.forEach(function(b,i) {
				view.setUint8(i, b);
			});
			var num = view.getFloat32(0);
		document.getElementById("buttonGetGetAVGScaleDisplay").innerHTML = (num.toString().substring(0,5));
		break;
		case "01002300":
			payload = value.substring(10, 18);
			
			var p0 = payload.substring(0, 2);
			var p1 = payload.substring(2, 4);
			var p2 = payload.substring(4, 6);
			var p3 = payload.substring(6, 8);
			
			var data = [ parseInt(p3, 16), parseInt(p2, 16), parseInt(p1, 16), parseInt(p0, 16)];
			
			var buf = new ArrayBuffer(4);
			var view = new DataView(buf);
			data.forEach(function(b,i) {
				view.setUint8(i, b);
			});
			var num = view.getFloat32(0);
		document.getElementById("buttonGetXScaleDisplay").innerHTML = (num.toString().substring(0,5));
		break;
		case "01002400":
			payload = value.substring(10, 18);
			
			var p0 = payload.substring(0, 2);
			var p1 = payload.substring(2, 4);
			var p2 = payload.substring(4, 6);
			var p3 = payload.substring(6, 8);
			
			var data = [ parseInt(p3, 16), parseInt(p2, 16), parseInt(p1, 16), parseInt(p0, 16)];
			
			var buf = new ArrayBuffer(4);
			var view = new DataView(buf);
			data.forEach(function(b,i) {
				view.setUint8(i, b);
			});
			var num = view.getFloat32(0);
		document.getElementById("buttonGetYScaleDisplay").innerHTML = (num.toString().substring(0,5));
		break;
		case "01002500":
			payload = value.substring(10, 18);
			
			var p0 = payload.substring(0, 2);
			var p1 = payload.substring(2, 4);
			var p2 = payload.substring(4, 6);
			var p3 = payload.substring(6, 8);
			
			var data = [ parseInt(p3, 16), parseInt(p2, 16), parseInt(p1, 16), parseInt(p0, 16)];
			
			var buf = new ArrayBuffer(4);
			var view = new DataView(buf);
			data.forEach(function(b,i) {
				view.setUint8(i, b);
			});
			var num = view.getFloat32(0);
		document.getElementById("buttonGetZScaleDisplay").innerHTML = (num.toString().substring(0,5));
		break;
	  default:
	  console.log("unknown binary stream");
	  retVal = 1;
	} 
	return retVal;
}

function sendCommandOnClick(element) { // sends commands to the client
	var tosend;
	tosend = document.getElementById(element).value; // get the data, which has to be sent
	WebConnection.send(tosend);
	console.log(tosend);
	storeSentData(tosend, true);
}

function buf2hex(buffer) { // buffer is an ArrayBuffer
  return Array.prototype.map.call(new Uint8Array(buffer), x => ('00' + x.toString(16)).slice(-2)).join('');
}

function StrToByteArr(str) {
	var charArr = str.split('');
	var hexPos = str.length - 1;
	var numOfBytes = 0;
	if ( str.length % 2 == 0)
		 numOfBytes = parseInt(str.length/2);
	else
		numOfBytes = parseInt(str.length/2) + 1;
	
	var binary = new Uint8Array(numOfBytes);
	for(var i = 0; i < numOfBytes; i++) {
		binary[i] = parseInt(charArr[hexPos], 16);
		hexPos--;
		if (hexPos >= 0) {
			var shifted = parseInt(charArr[hexPos], 16) << 4;
			hexPos--;
			binary[i] = binary[i] | shifted;
		}
		//console.log(binary[i].toString(16));
		
	}
	return binary.reverse();
	//return binary;
}

function StoreReceivedHexData(toStore) {
	try { 																	// code that may cause an error
        var inStorage = document.getElementById("StoreHexReceived").value; 		// get old data
        toStore = toStore + "\r"; 											// add newline to new data
        inStorage = inStorage + toStore;									// connect data
        document.getElementById("StoreHexReceived").value = inStorage; 			// write new data on page
    }
    catch (e) { 																// on error
        console.log("Could not store data in StoreHexReceived");
    }
}

function WebHexCmdSend(commandSrc) {
	var tosendStr = document.getElementById(commandSrc).value;
	var toSend = StrToByteArr(tosendStr);
	WebConnection.send(toSend.buffer);
	// StoreSentData("0x" + tosendStr);
	
	try { 																	// code that may cause an error
        var inStorage = document.getElementById("StoreHexSent").value; 		// get old data
        var toStore = tosendStr + "\r"; 											// add newline to new data
        inStorage = inStorage + toStore;									// connect data
        document.getElementById("StoreHexSent").value = inStorage; 			// write new data on page
    }
    catch (e) { 																// on error
        console.log("Could not store data in StoreHexSent");
    }
};

function EndWebsocketClient() {
	console.log("close");
	WebConnection.close();
	screenStatus(0);
}
function screenStatus(status) {
	if(status == 1) {
		document.getElementById("WebSocketConnectionStateScreen").innerHTML = "<span style='color:green'> Connected! </span>";
	}
	else if(status == 0) {
		document.getElementById("WebSocketConnectionStateScreen").innerHTML = "<span style='color:blue'> Disconnected! </span>";
	}
	else if(status == 2) {
		document.getElementById("WebSocketConnectionStateScreen").innerHTML = "<span style='color:red'> ERROR! </span>";
	}
}

function storeSentData(toStore) {
	try{ 																	// code that may cause an error
		var inStorage = document.getElementById("commandStore").value; 		// get old data
		toStore = toStore + "\r"; 											// add newline to new data
		inStorage = inStorage + toStore;									// connect data
		document.getElementById("commandStore").value = inStorage; 			// write new data on page
	}
	catch(e){ 																// on error
		console.log("Could not store data in commandStore");
	}
	try{ 																	// code that may cause an error
		inStorage = document.getElementById("AllStore").value; 				// get old data
		toStore = new Date() + " cmd : " + toStore; 						// add newline to new data
		inStorage = inStorage + toStore;									// connect data
		document.getElementById("AllStore").value = inStorage; 				// write new data on page
	}
	catch(e){ 																// on error
		console.log("Could not store data in AllStore");
	}
}

function storeReceivedData(toStore) {
	try{ 																	// code that may cause an error
		var inStorage = document.getElementById("receiveStore").value; 		// get old data
		toStore = toStore + "\r"; 											// add newline to new data
		inStorage = inStorage + toStore;									// connect data
		document.getElementById("receiveStore").value = inStorage; 			// write new data on page
	}
	catch(e){ 																// on error
		console.log("Could not store data in receiveStore");
    }

	try{ 																	// code that may cause an error
		inStorage = document.getElementById("AllStore").value; 			// get old data
		toStore = new Date() + " " + WebSocketIPAdress + " : " + toStore; 		// add newline to new data
		inStorage = inStorage + toStore;									// connect data
		document.getElementById("AllStore").value = inStorage; 				// write new data on page
	}
	catch(e){ 																// on error
		console.log("Could not store data in AllStore");
	}
}

var my_gamepad = null;
var refreshIntervalIdJoystick = null;

function OnJoystickConnect() {
    window.addEventListener("gamepadconnected", function(e) {
		my_gamepad = e.gamepad;
	})
	refreshIntervalIdJoystick = window.setInterval(CheckJoy, 250); // CheckJoy wird alle 250ms aufgerufen
}

function OnJoystickDisconnect() {
	clearInterval(refreshIntervalIdJoystick);
	window.removeEventListener('gamepadconnected', my_gamepad);
}

function CheckJoy() {
	if(my_gamepad != null) {
		console.log("Joy %f %f", my_gamepad.axes[0], my_gamepad.axes[3]);
		var xAxes = my_gamepad.axes[0] * 128 + 128; //LeftRight
		var yAxes = 0;
		var direction = 1;
		if(my_gamepad.axes[3] > 0){
			direction = 0;
			yAxes = 255 - my_gamepad.axes[3] * 255;
		}
		else
		{
			direction = 1;
			yAxes = -my_gamepad.axes[3] * 255;
		}
		if(xAxes > 255) {
			xAxes = 255;
		}
		if(xAxes < 1) {
			xAxes = 1;
		}
		console.log("LeftRight: %f, Velocity: %f, direction: %d", xAxes, yAxes, direction);

		var binary = new Uint8Array(10);
		binary[0] = 0x11;
		binary[1] = 0x03;
		binary[2] = 0x00;
		binary[3] = 0x00;
		binary[4] = 0x00;
		binary[5] = 0x00;
		binary[6] = 0x00;
		binary[7] = direction;
		binary[8] = yAxes;
		binary[9] = 0x12;
		WebConnection.send(binary);
		binary[3] = 0x01;
		binary[7] = 0x00;
		binary[8] = xAxes;
		WebConnection.send(binary);
		if (my_gamepad.buttons[0] == true){
			binary[1] = 0x02;
			binary[2] = 0x01;
			binary[8] = 0x00;
			WebConnection.send(binary);
		}
	}
}
var coll = document.getElementsByClassName("collapsible");
var i;

for (i = 0; i < coll.length; i++) {
  coll[i].addEventListener("click", function() {
    this.classList.toggle("active");
    var content = this.nextElementSibling;
    if (content.style.display === "block") {
      content.style.display = "none";
    } else {
      content.style.display = "block";
    }
  });
}

</script>
</html>